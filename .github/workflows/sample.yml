name: Build and Deploy

on:
  workflow_dispatch:
    inputs:
      BRANCH_NAME:
        type: string
        default: main
        description: Git branch to build
      BUILD_TYPE:
        type: choice
        options: ['development', 'staging', 'production']
        description: Build environment type
      RUN_TESTS:
        type: boolean
        default: true
        description: Run tests before building
      PUSH_IMAGE:
        type: boolean
        default: true
        description: Push Docker image to registry

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        
      - name: Build Application
        run: |
          make build ENV=${BUILD_TYPE}
          
      - name: Run Tests
        if: inputs.RUN_TESTS == 'true'
        run: |
          make test

      - name: Login to Docker Registry
        if: inputs.PUSH_IMAGE == 'true'
        uses: actions/checkout@v3
        with:
          credentials_id: docker-registry-credentials
        
      - name: Build Docker Image
        if: inputs.PUSH_IMAGE == 'true'
        run: |
          echo "Building docker image"
          
          DOCKER_TAG=${GITHUB_REF#refs/tags/} 
          if [ "${DOCKER_TAG}" = "" ]; then
            DOCKER_TAG=latest;
          fi

          # Build the Docker image
          docker build --build-arg ENV=${BUILD_TYPE} -t my-registry/my-application:$DOCKER_TAG .
          
      - name: Push Docker Image to Registry
        if: inputs.PUSH_IMAGE == 'true'
        run: |
          echo "Pushing Docker image"
          
          docker push my-registry/my-application:$GITHUB_REF
            
          # If on main branch, also tag and push as latest
          if [ "$GITHUB_REF" == "refs/heads/main" ]; then
            docker tag my-registry/my-application:$GITHUB_REF my-registry/my-application:latest
            docker push my-registry/my-application:latest
          fi
